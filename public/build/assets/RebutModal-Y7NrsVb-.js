import{a as g,j as e,b as u}from"./axios-DGPLTa3G.js";import{e as w}from"./react-select.esm-B9Exsq2_.js";const S=({depense:r,setDepense:o})=>{const[b,c]=g.useState(!1),f=()=>{c(!0);let l={...r,category_id:r.category_id?r.category_id.value:null};u.post("depense",l).then(n=>{toastr.success(n.data),$("#depense-modal").modal("hide"),o({nom:"",category_id:"",benificiaire:"",montant:0,description:"",session_id:__session_id}),c(!1)}).catch(n=>{if(c(!1),n.response.status==422){let _=n.response.data.errors,x="";for(let j in _)x+=`<p class="text-white">${_[j][0]}</p>`;toastr.warning(x)}else toastr.danger("Vuillez ressayer plus tard")})};return e.jsx("div",{className:"modal fade","data-bs-backdrop":"static",tabIndex:"-1",id:"depense-modal",style:{display:"none"},children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title align-self-center",children:"Ajouter une dépense"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense_nom",className:"form-label required",children:"Nom de depense"}),e.jsx("div",{className:"input-group",children:e.jsx("input",{id:"depense_nom",className:"form-control",type:"text",required:!0,value:r.nom,onChange:l=>{o({...r,nom:l.target.value})}})})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense-category",className:"form-label required",children:"Catégorie"}),e.jsx(w,{classNames:{control:()=>"border-light shadow-none",option:l=>l.isFocused?"bg-primary text-white":l.isSelected?"bg-soft-primary text-white":l.isDisabled?"bg-soft-light text-muted":"",singleValue:l=>{l.isFocused}},cache:!1,value:r.category_id,onChange:l=>o({...r,category_id:l}),options:__depenses})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense_benificiaire",className:"form-label required",children:"Bénéficiaire"}),e.jsx("div",{className:"input-group",children:e.jsx("input",{id:"depense_benificiaire",className:"form-control",type:"text",required:!0,value:r.benificiaire,onChange:l=>{o({...r,benificiaire:l.target.value})}})})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"montant",className:"form-label required",children:"Montant"}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{required:!0,className:"form-control",step:"0.01",min:"1",max:r.montant,type:"number",value:r.montant,onChange:l=>o({...r,montant:l.target.value}),id:"montant"}),e.jsx("span",{className:"input-group-text",children:"MAD"})]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-light","data-bs-dismiss":"modal",children:"Fermer"}),e.jsx("button",{className:"btn btn-success",onClick:()=>f(),disabled:b,children:b?"En cours...":"Ajouter"})]})]})})})},N=()=>({i_article_id:"",i_article_label:"",quantite_rebut:""}),k=()=>{const[r,o]=g.useState(!1),[b,c]=g.useState([N()]),[f,l]=g.useState(!1);g.useEffect(()=>{const a=()=>{__is_rebut==1&&o(!0)},s=()=>o(!1);return document.addEventListener("show.bs.modal",t=>{t.target&&t.target.id==="rebut-modal"&&a()}),document.addEventListener("hide.bs.modal",t=>{t.target&&t.target.id==="rebut-modal"&&s()}),()=>{}},[]);const n=(a,s)=>{c(t=>t.map((i,d)=>d===a?{...i,...s}:i))},_=()=>c(a=>[...a,N()]),x=a=>c(s=>s.filter((t,i)=>i!==a)),j=(()=>{const a={current:null};return async(s,t)=>{const i=(t||"").trim();if(n(s,{i_article_label:t}),a.current&&(clearTimeout(a.current),a.current=null),i.length<1){n(s,{__choices:void 0,i_article_id:""});return}a.current=setTimeout(async()=>{try{!u.defaults.baseURL&&typeof __api_url<"u"&&(u.defaults.baseURL=__api_url);const d=sessionStorage.getItem("access_token");d&&(u.defaults.headers.Authorization="Bearer "+d);const h=(await u.get("articles-liste",{params:{search:i}})).data||[];if(h.length===1){const m=h[0];n(s,{i_article_id:m.id,i_article_label:m.designation||m.libelle||m.nom||m.reference||m.ref||"#"+m.id,__choices:void 0}),console.log("Résultat de la recherche article:",h)}else h.length>1?n(s,{__choices:h}):(n(s,{__choices:[],i_article_id:""}),window.toastr&&toastr.warning("Aucun article trouvé"))}catch{window.toastr&&toastr.error("Erreur lors de la recherche")}finally{a.current=null}},300)}})(),v=(a,s)=>{n(a,{i_article_id:s.id,i_article_label:s.name?`${s.name}${s.reference?" ("+s.reference+")":""}`:s.libelle||s.nom||s.reference||s.ref||"#"+s.id,__choices:void 0})},y=async()=>{var s,t;const a={lignes:b.map(i=>({i_article_id:Number(i.i_article_id),quantite_rebut:Number(i.quantite_rebut)})).filter(i=>i.i_article_id&&i.quantite_rebut>0)};if(!a.lignes.length){window.toastr&&toastr.warning("Ajoutez au moins une ligne valide");return}l(!0);try{const i=await u.post("rebut",{...a,session_id:__session_id});window.toastr&&toastr.success(i.data&&i.data.message||"Rebut ajouté avec succès !"),c([N()]);const d=document.getElementById("rebut-modal");if(d){const p=(t=(s=window.bootstrap)==null?void 0:s.Modal)==null?void 0:t.getInstance(d);p==null||p.hide()}}catch{window.toastr&&toastr.error("Erreur lors de la création du rebut")}finally{l(!1)}};return r?e.jsx("div",{className:"modal fade show",id:"rebut-modal",style:{display:"block"},"aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Nouveau Rebut"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"container-fluid",children:[b.map((a,s)=>e.jsxs("div",{className:"row g-2 align-items-end mb-2",children:[e.jsxs("div",{className:"col-7",children:[e.jsx("label",{className:"form-label",children:"Article"}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Rechercher un article…",value:a.i_article_label,onChange:t=>j(s,t.target.value)}),!!(a.__choices&&a.__choices.length>1)&&e.jsx("div",{className:"position-absolute bg-white border rounded w-100 mt-1",style:{zIndex:1056},children:e.jsx("ul",{className:"list-unstyled mb-0",style:{maxHeight:"200px",overflowY:"auto"},children:a.__choices.map(t=>e.jsx("li",{className:"px-2 py-1 hover-bg-light cursor-pointer",onClick:()=>v(s,t),children:t.designation||t.libelle||t.nom||t.reference||t.ref?t.name?`${t.name}${t.reference?" ("+t.reference+")":""}`:t.libelle||t.nom||t.reference||t.ref:"#"+t.id},t.id))})})]})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("label",{className:"form-label",children:"Quantité de rebut"}),e.jsx("input",{type:"number",step:"0.01",className:"form-control",value:a.quantite_rebut,onChange:t=>n(s,{quantite_rebut:t.target.value})})]}),e.jsx("div",{className:"col-1 d-flex justify-content-end",children:e.jsx("button",{className:"btn btn-link text-danger",onClick:()=>x(s),title:"Supprimer",children:e.jsx("i",{className:"fa fa-trash"})})})]},s)),e.jsx("button",{className:"btn btn-light",onClick:_,children:"+ Ajouter une ligne"})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"Annuler"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:y,disabled:f,children:f?"Enregistrement…":"Enregistrer"})]})]})})}):e.jsx("div",{className:"modal fade",id:"rebut-modal",tabIndex:"-1","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsx("div",{className:"modal-content"})})})};export{S as D,k as R};
