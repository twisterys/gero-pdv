import{a as g,j as e,e as m}from"./index-CotjMrcd.js";import{e as y}from"./react-select.esm-DLNcz9Oi.js";const S=({depense:l,setDepense:n})=>{const[u,o]=g.useState(!1),f=()=>{o(!0);let i={...l,category_id:l.category_id?l.category_id.value:null};m.post("depense",i).then(r=>{toastr.success(r.data),$("#depense-modal").modal("hide"),n({nom:"",category_id:"",benificiaire:"",montant:0,description:"",session_id:__session_id}),o(!1)}).catch(r=>{if(o(!1),r.response.status==422){let _=r.response.data.errors,x="";for(let p in _)x+=`<p class="text-white">${_[p][0]}</p>`;toastr.warning(x)}else toastr.danger("Vuillez ressayer plus tard")})};return e.jsx("div",{className:"modal fade","data-bs-backdrop":"static",tabIndex:"-1",id:"depense-modal",style:{display:"none"},children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title align-self-center",children:"Ajouter une dépense"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense_nom",className:"form-label required",children:"Nom de depense"}),e.jsx("div",{className:"input-group",children:e.jsx("input",{id:"depense_nom",className:"form-control",type:"text",required:!0,value:l.nom,onChange:i=>{n({...l,nom:i.target.value})}})})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense-category",className:"form-label required",children:"Catégorie"}),e.jsx(y,{classNames:{control:()=>"border-light shadow-none",option:i=>i.isFocused?"bg-primary text-white":i.isSelected?"bg-soft-primary text-white":i.isDisabled?"bg-soft-light text-muted":"",singleValue:i=>{i.isFocused}},cache:!1,value:l.category_id,onChange:i=>n({...l,category_id:i}),options:__depenses})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"depense_benificiaire",className:"form-label required",children:"Bénéficiaire"}),e.jsx("div",{className:"input-group",children:e.jsx("input",{id:"depense_benificiaire",className:"form-control",type:"text",required:!0,value:l.benificiaire,onChange:i=>{n({...l,benificiaire:i.target.value})}})})]}),e.jsxs("div",{className:"col-12 mt-3",children:[e.jsx("label",{htmlFor:"montant",className:"form-label required",children:"Montant"}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{required:!0,className:"form-control",step:"0.001",min:"1",max:l.montant,type:"number",value:l.montant,onChange:i=>n({...l,montant:i.target.value}),id:"montant"}),e.jsx("span",{className:"input-group-text",children:"MAD"})]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-light","data-bs-dismiss":"modal",children:"Fermer"}),e.jsx("button",{className:"btn btn-success",onClick:()=>f(),disabled:u,children:u?"En cours...":"Ajouter"})]})]})})})},j=()=>({i_article_id:"",i_article_label:"",quantite_rebut:""}),k=()=>{const[l,n]=g.useState(!1),[u,o]=g.useState([j()]),[f,i]=g.useState(!1);g.useEffect(()=>{const a=()=>{__is_rebut==1&&n(!0)},t=()=>n(!1);return document.addEventListener("show.bs.modal",s=>{s.target&&s.target.id==="rebut-modal"&&a()}),document.addEventListener("hide.bs.modal",s=>{s.target&&s.target.id==="rebut-modal"&&t()}),()=>{}},[]);const r=(a,t)=>{o(s=>s.map((c,h)=>h===a?{...c,...t}:c))},_=()=>o(a=>[...a,j()]),x=a=>o(t=>t.filter((s,c)=>c!==a)),p=(()=>{const a={current:null};return async(t,s)=>{const c=(s||"").trim();if(r(t,{i_article_label:s}),a.current&&(clearTimeout(a.current),a.current=null),c.length<1){r(t,{__choices:void 0,i_article_id:""});return}a.current=setTimeout(async()=>{try{!m.defaults.baseURL&&typeof __api_url<"u"&&(m.defaults.baseURL=__api_url);const h=sessionStorage.getItem("access_token");h&&(m.defaults.headers.Authorization="Bearer "+h);const b=(await m.get("articles-liste",{params:{search:c}})).data||[];if(b.length===1){const d=b[0];r(t,{i_article_id:d.id,i_article_label:d.designation||d.libelle||d.nom||d.reference||d.ref||"#"+d.id,__choices:void 0}),console.log("Résultat de la recherche article:",b)}else b.length>1?r(t,{__choices:b}):(r(t,{__choices:[],i_article_id:""}),window.toastr&&toastr.warning("Aucun article trouvé"))}catch{window.toastr&&toastr.error("Erreur lors de la recherche")}finally{a.current=null}},300)}})(),N=(a,t)=>{r(a,{i_article_id:t.id,i_article_label:t.name?`${t.name}${t.reference?" ("+t.reference+")":""}`:t.libelle||t.nom||t.reference||t.ref||"#"+t.id,__choices:void 0})},v=async()=>{const a={lignes:u.map(t=>({i_article_id:Number(t.i_article_id),quantite_rebut:Number(t.quantite_rebut)})).filter(t=>t.i_article_id&&t.quantite_rebut>0)};if(!a.lignes.length){window.toastr&&toastr.warning("Ajoutez au moins une ligne valide");return}i(!0);try{const t=await m.post("rebut",{...a,session_id:__session_id});window.toastr&&toastr.success(t.data&&t.data.message||"Rebut ajouté avec succès !"),o([j()]);const s=document.getElementById("rebut-modal");s&&window.bootstrap?.Modal?.getInstance(s)?.hide()}catch{window.toastr&&toastr.error("Erreur lors de la création du rebut")}finally{i(!1)}};return l?e.jsx("div",{className:"modal fade show",id:"rebut-modal",style:{display:"block"},"aria-modal":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Nouveau Rebut"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"container-fluid",children:[u.map((a,t)=>e.jsxs("div",{className:"row g-2 align-items-end mb-2",children:[e.jsxs("div",{className:"col-7",children:[e.jsx("label",{className:"form-label",children:"Article"}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Rechercher un article…",value:a.i_article_label,onChange:s=>p(t,s.target.value)}),!!(a.__choices&&a.__choices.length>1)&&e.jsx("div",{className:"position-absolute bg-white border rounded w-100 mt-1",style:{zIndex:1056},children:e.jsx("ul",{className:"list-unstyled mb-0",style:{maxHeight:"200px",overflowY:"auto"},children:a.__choices.map(s=>e.jsx("li",{className:"px-2 py-1 hover-bg-light cursor-pointer",onClick:()=>N(t,s),children:s.designation||s.libelle||s.nom||s.reference||s.ref?s.name?`${s.name}${s.reference?" ("+s.reference+")":""}`:s.libelle||s.nom||s.reference||s.ref:"#"+s.id},s.id))})})]})]}),e.jsxs("div",{className:"col-4",children:[e.jsx("label",{className:"form-label",children:"Quantité de rebut"}),e.jsx("input",{type:"number",step:"0.001",className:"form-control",value:a.quantite_rebut,onChange:s=>r(t,{quantite_rebut:s.target.value})})]}),e.jsx("div",{className:"col-1 d-flex justify-content-end",children:e.jsx("button",{className:"btn btn-link text-danger",onClick:()=>x(t),title:"Supprimer",children:e.jsx("i",{className:"fa fa-trash"})})})]},t)),e.jsx("button",{className:"btn btn-light",onClick:_,children:"+ Ajouter une ligne"})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"Annuler"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:v,disabled:f,children:f?"Enregistrement…":"Enregistrer"})]})]})})}):e.jsx("div",{className:"modal fade",id:"rebut-modal",tabIndex:"-1","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsx("div",{className:"modal-content"})})})};export{S as D,k as R};
